% Compile with xelatex
\documentclass[12pt,twoside,symmetric,nobib]{tufte-book}
\usepackage[
  backend=biber,
  style=authoryear
]{biblatex}
\addbibresource{book.bib}
\usepackage{zref-savepos}
\usepackage{zref-abspage}
\usepackage{eso-pic}
\usepackage{xeCJK}
\usepackage{csquotes}
\usepackage{newfloat}
\usepackage{nameref}
\usepackage{tasks}
\usepackage{forest}
\usepackage{amsmath}
\usepackage{subcaption}
\usepackage{xparse}
\usepackage{prettyref}
\usepackage{tabularx}
\usepackage{array}
\usepackage{booktabs}
\usepackage{qrcode}
\usepackage{etoolbox}
\usepackage{fmtcount}

\def\giturl{https://github.com/tathougies/csforkids}

\newrefformat{subfig}{Figure~\ref{#1}\subref{#1}}
\newrefformat{fig}{Figure~\ref{#1}\ifnum\getpagerefnumber{#1}=\value{page}~on this page\else~on page~\pageref{#1}\fi}
\newrefformat{sec}{{\bfseries \nameref{#1}}\ifnum\getpagerefnumber{#1}=\value{page}~on this page\else~on page~\pageref{#1}\fi}
\newcolumntype{L}{>{\raggedright\arraybackslash}X}

\makeatletter
\def\input@path{{util/}}
\makeatother

\usepackage{turingtumble}

\usepackage{tikz}
\usepackage {tikzpagenodes}
\usetikzlibrary{calc,external,decorations.pathreplacing,arrows.meta,positioning,fit,tikzmark,ducks}
% \tikzexternalize[prefix=figure-cache/]
\usepackage{caption}

\usepackage{graphicx} % for \rotatebox
\usepackage{atbegshi}

\pgfkeys{
  /tcb/code note/.style={enhanced jigsaw, width=4cm, colback=white, opacityback=0.4, boxrule=0.6pt, colframe=black, drop shadow southeast}
}

\makeatletter
\newcommand{\CheckTikzPictureSide}{
  \checkoddpage
  \ifoddpage
  \def\tikztufteouter{east}
  \def\tikztufteinne{west}
  \else
  \def\tikztufteouter{west}
  \def\tikztufteinner{east}
  \fi
}
\makeatother
\newcommand{\attribution}[1]{{\textcolor{lightgray}{\tiny #1}}}

% -- upside-down footnotes --

% Unmarked footnote at bottom (no symbol/number), content printed upside down.
% Does not consume a footnote number.
\newcommand{\upfootnote}[2][0.95\linewidth]{%
  \AtBeginShipoutNext{%
    \begingroup
      \renewcommand\thefootnote{}%
      \insert\footins{%
        \rotatebox{180}{%
          \begin{minipage}{#1}
            \small\itshape #2
          \end{minipage}%
        }%
      }%
    \endgroup
  }%
}
% ---------- Fonts (project-local) ----------
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}

% Put fonts in:
% fonts/Charter/Charter-Regular.ttf, etc.
% fonts/SourceSans3/SourceSans3-Regular.ttf, etc.
% fonts/JetBrainsMono/JetBrainsMono-Regular.ttf, etc.

\input{fonts.tex}
% ---------- Microtype (works fine with XeTeX) ----------
\usepackage{microtype}

% ---------- Links ----------


% ---------- Color + boxes ----------
\usepackage{xcolor}
\definecolor{IdeaBlue}{HTML}{1F77B4}
\definecolor{TryGreen}{HTML}{2CA02C}
\definecolor{DeepPurple}{HTML}{9467BD}
\definecolor{TrackOrange}{HTML}{FF7F0E}
\definecolor{SoftGray}{HTML}{F5F5F5}
\definecolor{DefinitionAmber}{RGB}{191,135,0}
\definecolor{TermSage}{RGB}{120,150,120}
\definecolor{CaptionLabelSlate}{RGB}{70,95,110}
\definecolor{HuhRed}{RGB}{165,58,42}
\definecolor{ColumnHeaderBlue}{RGB}{45,95,140}

\DeclareCaptionLabelFormat{boldcolored}{%
  \textsf{\textbf{\textcolor{CaptionLabelSlate}{#1~#2}}}
}

\newcommand{\headercol}[1]{\textbf{\textsf{\textcolor{ColumnHeaderBlue}{#1}}}}

\captionsetup{
  font={sf,footnotesize},
  textfont={sf,footnotesize},
  labelformat=boldcolored,
  labelsep=space
}

\captionsetup[table]{
  font={sf,footnotesize},
  textfont={sf,footnotesize},
  labelformat=boldcolored,
  labelsep=space
}

\captionsetup[marginfigure]{
  font={sf,footnotesize},
  textfont={sf,footnotesize,color=black!85}
}
\captionsetup[table*]{skip=8pt}

\newcommand{\tikzbackground}[1]{
  \AddToHookNext{shipout/background}{
    \begin{tikzpicture}[remember picture, overlay]
      \CheckTikzPictureSide
      #1
    \end{tikzpicture}
  }
}
\newcommand{\tikzforeground}[1]{
  \begin{tikzpicture}[remember picture, overlay]
    \CheckTikzPictureSide
    #1
  \end{tikzpicture}
}

\usepackage[most]{tcolorbox}
\tcbuselibrary{listings,skins,breakable}
\tcbset{
  enhanced,
  boxrule=0.8pt,
  arc=2mm,
  left=2mm,right=2mm,top=1.2mm,bottom=1.2mm,
}

\lstdefinestyle{replstyle}{
  basicstyle=\ttfamily\small,
  columns=fullflexible,
  keepspaces=true,
  showstringspaces=false,
  escapeinside={(*@}{@*)},
  lineskip={2pt},
  literate={<ENTER>}{{\enterkey}}7
}
\newtcblisting{replbox}[1][]{
  enhanced,
  breakable,
  colback=TryGreen!6,
  colframe=TryGreen!55,
  boxrule=0.6pt,
  arc=2mm,
  left=6pt,right=6pt,top=6pt,bottom=6pt,
  fonttitle=\sffamily\bfseries,
  title=Try This!,
  listing only,
  listing options={style=replstyle,#1}
}
\newtcblisting{replboxannotated}[1][]{
  enhanced,
  breakable,
  colback=TryGreen!6,
  colframe=TryGreen!55,
  boxrule=0.6pt,
  arc=2mm,
  left=6pt,right=6pt,top=6pt,bottom=6pt,
  fonttitle=\sffamily\bfseries,
  title=Try This!,
  listing only,
  listing options={style=replstyle,#1}
}

\DeclareFloatingEnvironment{bookbox}

\newcommand{\currboxcolor}{black}
\newif\ifintcb
\newtcolorbox{BigIdeaBox}{
  colback=IdeaBlue!6,colframe=IdeaBlue!55,
  title={\sffamily\bfseries Big Idea},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{IdeaBlue}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{TryThisBox}{
  colback=TryGreen!6,colframe=TryGreen!55,
  title={\sffamily\bfseries Try This!},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{TryGreen}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{DeepDiveBox}{
  colback=DeepPurple!6,colframe=DeepPurple!55,
  title={\sffamily\bfseries Optional: Going Deeper},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{DeepPurple}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{TrackBox}[1]{
  colback=TrackOrange!6,colframe=TrackOrange!55,
  title={\sffamily\bfseries Track: #1},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{TrackOrange}\intcbtrue},
  after upper={\intcbfalse}
}
\newcommand{\tryitsection}{\textbf{\large \textcolor{IdeaBlue}{\sffamily Try This!}}}
\newcommand{\boxtitle}[1]{\def\currentboxtitle{#1}\textbf{\sffamily \large \textcolor{\currboxcolor}{#1}}}

\makeatletter
\newcommand{\onfloatpage}[2]{
    % #1 = float label
  % #2 = code to run
  \AddToHook{shipout/foreground}{%
    \begingroup
      \edef\ShipoutPage{\the\c@page}%
      \edef\TargetPage{\getpagerefnumber{#1}}%
      \ifx\ShipoutPage\TargetPage
        #2%
        \RemoveFromHook{shipout/foreground}%
      \fi
    \endgroup
  }%
}
\makeatother

\newcommand{\margmark}[2]{
  \tikzmarknode{#1}{\strut}
  \makemargmark{#1}{#2}
}

\makeatletter
\newcommand{\makemargmark@odd}[2]{
  \tikz[remember picture,overlay]{
    \coordinate (x) at ([xshift=\marginparsep]current page text area.east |- #1.east);
    \node[anchor=west, align=left, font=\footnotesize, text width=\marginparwidth] at (x) {\begin{minipage}{\marginparwidth}\sffamily odd #2\end{minipage}};
  }
}
\newcommand{\makemargmark@even}[2]{
  \tikz[remember picture,overlay]{
    \coordinate (x) at ([xshift=-\marginparsep]current page text area.west |- #1.east);
    \node[anchor=east, align=left, font=\footnotesize, text width=\marginparwidth] at (x) {\begin{minipage}{\marginparwidth}\sffamily even #2\end{minipage}};
  }
}

\newcommand{\makemargmark}[2]{
  \ifintcb
  \tcbifoddpage{\makemargmark@odd{#1}{#2}}{\makemargmark@even{#1}{#2}}
  \else
  \checkoddpage
  \ifoddpage
  \makemargmark@odd{#1}{#2}
  \else
  \makemargmark@even{#1}{#2}
  \fi
  \fi
}

\newcommand{\bookboxmargin}[2]{% #1=id, #2=text
  \AddToShipoutPictureFG*{%
    \put(0,0){%
      \makebox[0pt][l]{%
        \raisebox{\zposy{#1}sp}{%
          % crude "outer margin" x placement; tune to tufte-book geometry
          \hspace*{\paperwidth-\marginparwidth-1in}%
          \parbox{\marginparwidth}{\footnotesize #2}%
        }%
      }%
    }%
  }%
}
\usepackage{titlesec}
\titleformat{\chapter}
  {\sffamily\bfseries\Huge}
  {\thechapter}{0.8em}{}
\titleformat{\section}
  {\sffamily\bfseries\Large}
  {\thesection}{0.8em}{}
\titleformat{\subsection}
  {\sffamily\bfseries\large}
  {\thesubsection}{0.8em}{}


% Optional: Track margin callout
  \definecolor{TrackOrange}{HTML}{FF7F0E} % if not already defined
  \newcommand{\fixfigure}{\checkoddpage \ifoddpage \forcerectofloat \else \forceversofloat \fi}
  \AtBeginEnvironment{figure}{\fixfigure}
  \AtBeginEnvironment{table}{\fixfigure}
\newcommand{\mTrackBox}[2]{\marginbox{Track: #1}{TrackOrange}{#2}}
\newcommand{\marginbox}[3]{\marginnote{\textsf{\textbf{\textcolor{#2}{#1}}}\\{\sffamily #3}}}

\definecolor{CodeBackground}{HTML}{F2F2F2}
\definecolor{CodeBorder}{HTML}{555555}
\newtcbox{\code}{
  on line,
  box align=base,
  colback=CodeBackground,
  colframe=CodeBorder,
  boxrule=0.6pt,
  arc=3pt,
  left=3pt,
  right=3pt,
  boxsep=1pt,
  top=0pt,
  bottom=0pt,
  fontupper=\ttfamily\footnotesize,
  nobeforeafter
}

% ---------- Lists ----------
\usepackage{enumitem}
\setlist[itemize]{topsep=0.2em,itemsep=0.2em,leftmargin=1.2em}
\setlist[enumerate]{topsep=0.2em,itemsep=0.2em,leftmargin=1.4em}

\newcounter{exerciseno}[chapter]
\renewcommand{\theexerciseno}{W\theweek-\arabic{exerciseno}}
\newcounter{week}

\newcommand{\week}[1]{%
  \refstepcounter{week}%
  \chapter{Week \theweek: #1}%
}

\newlist{exercises}{enumerate}{1}
\setlist[exercises,1]{%
  label=\textcolor{IdeaBlue}{\sffamily\bfseries W\theweek-\arabic*},
  ref=W\theweek-\arabic*,
}

\settasks{
  label=\arabic*
}

% ---------- Answer collection to an appendix ----------
\makeatletter

\newcommand{\Exercises}{
  \section*{Exercises}

  \begingroup
  \immediate\write\tt@answers{
    \string\AnswerHeading{Week \theweek}
  }
  \endgroup
}
\newwrite\tt@answers
\AtBeginDocument{%
  \immediate\openout\tt@answers=\jobname.answers.tex%
}
\AtEndDocument{%
  \immediate\closeout\tt@answers%
}

% Write an answer for the *current* exercise number
\newcommand{\answer}[1]{%
  \begingroup
    % Write a macro call into the answers file.
    \immediate\write\tt@answers{%
    \string\AnswerItem{\thechapter-\theenumi}{#1}%
    }%
  \endgroup
}
\newcommand{\AnswerItem}[2]{%
\item[\textcolor{IdeaBlue}{\sffamily\bfseries #1}] #2%
}%
\newcommand{\AnswerHeading}[1]{
\item \textbf{\textsf{\textcolor{SoftGray}{#1}}}
}

% Print all answers (put this in your Appendix)
\newcommand{\printanswers}{%
    % Define how each saved answer line is rendered
  \begin{description}
    \item[test] hello
    \IfFileExists{\jobname.answers.tex}{
      \input{\jobname.answers.tex}
    }{\item[Error] Please run \LaTeX again}
  \end{description}
}
\makeatother

% ---------- Keyboard ----------
\newcommand{\litkey}[1]{\;\tikz[baseline=-0.6ex]\node[draw,rounded corners=2pt,inner sep=2pt,font=\scriptsize\sffamily]{#1};}
\newcommand{\enterkey}{\litkey{Enter}}
\newcommand{\spacekey}{\litkey{Space}}
\newcommand{\tabkey}{\litkey{Tab}}
\newcommand{\controlkey}{\litkey{Control}}

% ---------- Code ----------
\usepackage{listings}

\definecolor{CodeKeyword}{HTML}{2F6FDB}  % calm blue
\definecolor{CodeComment}{HTML}{6A737D}  % soft gray
\definecolor{CodeString}{HTML}{2DA44E}   % muted green
\definecolor{CodeNumber}{HTML}{8A4F7D}   % gentle plum
\definecolor{CodeBuiltin}{HTML}{B45309}  % warm amber

\newcommand{\kw}[1]{\texttt{\textbf{\textcolor{CodeKeyword}{#1}}}}

\lstdefinestyle{kidcode}{
  backgroundcolor=\color{SoftGray},
  basicstyle=\ttfamily\small,
  frame=single,
  rulecolor=\color{black!25},
  breaklines=true,
  showstringspaces=false,
  tabsize=2,
  xleftmargin=0.5em,
  xrightmargin=0.5em,
  literate=
    {<ENTER>}{\enterkey}7
    {<SPACE>}{\spacekey}5
}
\lstset{
  style=kidcode,
  language=Python,
  keywordstyle=\color{CodeKeyword}\bfseries,
  commentstyle=\color{CodeComment}\itshape,
  stringstyle=\color{CodeString},
  basicstyle=\ttfamily\small,
  showstringspaces=false,
  moredelim=**[is][\itshape]{@@}{@@}
}

% ---------- “Tufte-style” margin helpers ----------
% tufte-book already provides \marginnote and \marginfigure.
% These wrappers keep your usage consistent.

\def\notestyle{\raggedright\sffamily\footnotesize\color{black}}
\newcommand{\aside}[1]{\marginnote{\notestyle\color{black}#1}}
\newcommand{\curious}[1]{\marginnote{\notestyle\curiousboxtext\color{black}#1}}
\newcommand{\didyouknow}[1]{\marginnote{\notestyle\textbf{\textcolor{IdeaBlue}{Did You Know? }}\color{black}#1}}
\newcommand{\hint}[1]{\marginnote{\notestyle\hintnote\color{black}#1}}
\newcommand{\huh}[2]{\marginnote{\notestyle\huhnote{#1}\\\color{black}#2}}

\def\huhnote#1{\textbf{\textcolor{HuhRed}{Confused?}}\\\textbf{#1}}
\def\hintnote{\textbf{\textcolor{TryGreen}{Hint}} }
\def\curiousboxtext{\textbf{\textcolor{DeepPurple}{\sffamily Curious? }}}

\NewDocumentCommand{\pseudofigure}{o m m}{
  \par\medskip
  #3\par
  \captionof{figure}{#2}
  \IfValueT{#1}{\label{#1}}
}

% A margin image helper (use with an image file in images/)
\newcommand{\asideimg}[2][]{%
  \marginnote{\includegraphics[width=\marginparwidth,#1]{#2}}
}

\newcommand{\term}[1]{\textcolor{DefinitionAmber}{\textbf{#1}}}
\newcommand{\termheading}[1]{%
  \par\medskip
      {\sffamily\large\bfseries \textcolor{TermSage}{#1}}\par
      \vspace{0.4\baselineskip}
}
\makeatletter
\newlength{\oddshift}
\newcommand{\captionatbottom}{% from https://tex.stackexchange.com/a/229419/161015
    \long\def\@caption##1[##2]##3{%
    \par
    \addcontentsline{\csname ext@##1\endcsname}{##1}%
    {\protect\numberline{\csname the##1\endcsname}{\ignorespaces ##2}}%
    \begingroup
    \@parboxrestore%
    \if@minipage\@setminipage\fi%
    \normalsize
    \@makecaption{\csname fnum@##1\endcsname}{\ignorespaces ##3}\par
    \endgroup}
\long\def\@makecaption##1##2{%
\vskip\abovecaptionskip%
\@tufte@checkoddpage%
\ifthenelse{\boolean{@tufte@odd@page}}%
{\rlap{\parbox{\textwidth+\marginparwidth+\marginparsep}{\hskip0pt\@tufte@caption@font##1: ##2}}}%
{\setlength{\oddshift}{-\marginparwidth-\marginparsep}\rlap{\hskip\oddshift\parbox{\textwidth+\marginparwidth+\marginparsep}{\sffamily \textcolor{CaptionLabelSlate}{\textbf{##1}} ##2}}}%
\vskip\belowcaptionskip%
}
    \let\caption\@tufte@orig@caption%
    \let\label\@tufte@orig@label}

\newenvironment{largetable}{%
\clearpage
  \@tufte@checkoddpage%
  \begin{fullwidth}
    \captionsetup{type=table,labelformat=boldcolored,font={sf},textfont={sf}}
    \captionatbottom
    \begin{adjustwidth}{}{}\captionatbottom
}{\end{adjustwidth}
                 \end{fullwidth}
                 \clearpage}
\makeatother
% ---------- Document ----------
\title{How Computers Think}
\author{Travis Athougies}
\date{}

\begin{document}
\maketitle
\tableofcontents

\mainmatter
\input{../week1/chapter.tex}
\input{../week2/chapter.tex}
%\input{../week3/chapter.tex}
%\input{../week4/chapter.tex}

\appendix

\chapter{Answers}

\printanswers

\end{document}
