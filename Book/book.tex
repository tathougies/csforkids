% Compile with xelatex
\documentclass[12pt,twoside,symmetric,nobib]{tufte-book}
\usepackage{needspace}
\usepackage[
  backend=biber,
  style=authoryear
]{biblatex}
\addbibresource{book.bib}
%\usepackage{zref-savepos}
%\usepackage{zref-abspage}
%\usepackage{eso-pic}
\usepackage{capt-of}
\usepackage{xeCJK}
\usepackage{csquotes}
\usepackage{newfloat}
\usepackage{nameref}
\usepackage{tasks}
\usepackage{forest}
\usepackage{amsmath}
%\usepackage{caption}
% \usepackage[caption=false]{subfig}
\usepackage{xparse}
\usepackage{prettyref}
\usepackage{tabularx}
\usepackage{array}
\usepackage{booktabs}
\usepackage{qrcode}
\usepackage{etoolbox}
\usepackage{fmtcount}

\makeatletter
\patchcmd{\@caption}{: \ignorespaces}{\; \ignorespaces}{}{}
\makeatother
\makeatletter
\AtBeginDocument{\typeout{MAKECAPTION=\meaning\@makecaption}}
\makeatother
\def\giturl{https://github.com/tathougies/csforkids}

\newcommand{\prettypageref}[1]{\ifnum\getpagerefnumber{#1}=\value{page}~on this page\else~on page~\pageref{#1}\fi}
\newrefformat{subfig}{Figure~\ref{#1}\prettypageref{#1}}
\newrefformat{fig}{Figure~\ref{#1}\prettypageref{#1}}
\newrefformat{sec}{{\bfseries \nameref{#1}}\prettypageref{#1}}
\newrefformat{deepdive}{the Deep Dive Box~\prettypageref{#1}}
\newcolumntype{L}{>{\raggedright\arraybackslash}X}

\makeatletter
\def\input@path{{util/}}
\makeatother

\usepackage{turingtumble}

\usepackage{tikz}
\usepackage {tikzpagenodes}
\usetikzlibrary{calc,external,decorations.pathreplacing,arrows.meta,positioning,fit,tikzmark,ducks}
% \tikzexternalize[prefix=figure-cache/]

\usepackage{graphicx} % for \rotatebox
\usepackage{atbegshi}

\pgfkeys{
  /tcb/white code note/.style={opacityback=1.0},
  /tcb/code note/.style={enhanced jigsaw, width=4cm, colback=white, opacityback=0.4, boxrule=0.6pt, colframe=black, drop shadow southeast, fontupper={\footnotesize\sffamily}}
}

\pgfkeys{
  /week/.is family, /week,
  description/.initial={}
}

\makeatletter
\pgfkeys{
  /resource/.is family, /resource,
  description/.initial={},
  kind/.initial={},
  is url/.style={
    text={\resource@url}
  },
  text/.initial={},
  site text/.initial={},
  qrcode/.style={includeqr=1},
  includeqr/.initial=0,
  default/.style={
    description={},
    kind={Resource},
    text={},
    site text={\resource@name},
    includeqr=0
  }
}


\newcommand{\CheckTikzPictureSide}{
  \checkoddpage
  \ifoddpage
  \def\tikztufteouter{east}
  \def\tikztufteinne{west}
  \else
  \def\tikztufteouter{west}
  \def\tikztufteinner{east}
  \fi
}
\makeatother
\newcommand{\attribution}[1]{{\textcolor{lightgray}{\tiny #1}}}

% -- upside-down footnotes --

% Unmarked footnote at bottom (no symbol/number), content printed upside down.
% Does not consume a footnote number.
\newcommand{\upfootnote}[2][0.95\linewidth]{%
  \AtBeginShipoutNext{%
    \begingroup
      \renewcommand\thefootnote{}%
      \insert\footins{%
        \rotatebox{180}{%
          \begin{minipage}{#1}
            \small\itshape #2
          \end{minipage}%
        }%
      }%
    \endgroup
  }%
}
% ---------- Fonts (project-local) ----------
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}

% Put fonts in:
% fonts/Charter/Charter-Regular.ttf, etc.
% fonts/SourceSans3/SourceSans3-Regular.ttf, etc.
% fonts/JetBrainsMono/JetBrainsMono-Regular.ttf, etc.

\input{fonts.tex}
% ---------- Microtype (works fine with XeTeX) ----------
\usepackage{microtype}

% ---------- Links ----------


% ---------- Color + boxes ----------
\usepackage{xcolor}
\definecolor{IdeaBlue}{HTML}{1F77B4}
\definecolor{TryGreen}{HTML}{2CA02C}
\definecolor{DeepPurple}{HTML}{9467BD}
\definecolor{TrackOrange}{HTML}{FF7F0E}
\definecolor{SoftGray}{HTML}{F5F5F5}
\definecolor{DefinitionAmber}{RGB}{191,135,0}
\definecolor{TermSage}{RGB}{120,150,120}
\definecolor{CaptionLabelSlate}{RGB}{70,95,110}
\definecolor{HuhRed}{RGB}{165,58,42}
\definecolor{ColumnHeaderBlue}{RGB}{45,95,140}

\newcommand{\headercol}[1]{\textbf{\textsf{\textcolor{ColumnHeaderBlue}{#1}}}}

\setcaptionfont{\sffamily\footnotesize}
\makeatletter
% Your label style: sans, bold, colored
\newcommand{\TufteCaptionLabelStyle}[1]{%
  \textsf{\textbf{\textcolor{CaptionLabelSlate}{#1}}}%
}

% Apply to Figure/Table labels
\renewcommand{\fnum@figure}{\TufteCaptionLabelStyle{Figure~\thefigure}}
\renewcommand{\fnum@table}{\TufteCaptionLabelStyle{Table~\thetable}}
\makeatother

\AtBeginEnvironment{table*}{\setlength{\belowcaptionskip}{8pt}}

%\DeclareCaptionLabelFormat{boldcolored}{%
%  \textsf{\textbf{\textcolor{CaptionLabelSlate}{#1~#2}}}
%
%\captionsetup{
%  font={sf,footnotesize},
%  textfont={sf,footnotesize},
%  labelformat=boldcolored,
%  labelsep=space
%}
%
%\captionsetup[table]{
%  font={sf,footnotesize},
%  textfont={sf,footnotesize},
%  labelformat=boldcolored,
%  labelsep=space
%}
%
%\captionsetup[marginfigure]{
%  font={sf,footnotesize},
%  textfont={sf,footnotesize,color=black!85}
%}
%\captionsetup[table*]{skip=8pt}

\newcommand{\tikzbackground}[1]{
  \AddToHookNext{shipout/background}{
    \begin{tikzpicture}[remember picture, overlay]
      \CheckTikzPictureSide
      #1
    \end{tikzpicture}
  }
}
\newcommand{\tikzforeground}[1]{
  \AddToHookNext{shipout/foreground}{%
    \begin{tikzpicture}[remember picture, overlay]
      \CheckTikzPictureSide
      #1
    \end{tikzpicture}
  }
}

\usepackage[most]{tcolorbox}
\tcbuselibrary{listings,skins,breakable}
\tcbset{
  enhanced,
  boxrule=0.8pt,
  arc=2mm,
  left=2mm,right=2mm,top=1.2mm,bottom=1.2mm,
}

\lstdefinestyle{replstyle}{
  basicstyle=\ttfamily\small,
  columns=fullflexible,
  keepspaces=true,
  showstringspaces=false,
  escapeinside={(*@}{@*)},
  lineskip={2pt},
  literate={<ENTER>}{{\enterkey}}7
}
\newtcblisting{replbox}[1][]{
  enhanced,
  breakable,
  colback=TryGreen!6,
  colframe=TryGreen!55,
  boxrule=0.6pt,
  arc=2mm,
  left=6pt,right=6pt,top=6pt,bottom=6pt,
  fonttitle=\sffamily\bfseries,
  title=Try This!,
  listing only,
  listing options={style=replstyle,#1}
}

\newtcblisting{replboxannotated}[1][]{
  enhanced,
  breakable,
  colback=TryGreen!6,
  colframe=TryGreen!55,
  boxrule=0.6pt,
  arc=2mm,
  left=6pt,right=6pt,top=6pt,bottom=6pt,
  fonttitle=\sffamily\bfseries,
  title=Try This!,
  listing engine=listings,
  listing only=false,
  listing and text,
  listing options={style=replstyle,#1}
}

\DeclareFloatingEnvironment{bookbox}

\newcommand{\currboxcolor}{black}
\newif\ifintcb
\newtcolorbox{BigIdeaBox}{
  colback=IdeaBlue!6,colframe=IdeaBlue!55,
  title={\sffamily\bfseries Big Idea},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{IdeaBlue}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{TryThisBox}{
  colback=TryGreen!6,colframe=TryGreen!55,
  title={\sffamily\bfseries Try This!},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{TryGreen}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{DeepDiveBox}{
  colback=DeepPurple!6,colframe=DeepPurple!55,
  title={\sffamily\bfseries Optional: Going Deeper},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{DeepPurple}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{DeepDiveBoxFloat}{
  colback=DeepPurple!6,colframe=DeepPurple!55,
  title={\sffamily\bfseries Optional: Going Deeper},
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{DeepPurple}\intcbtrue},
  after upper={\intcbfalse}
}
\newtcolorbox{TrackBox}[1]{
  colback=TrackOrange!6,colframe=TrackOrange!55,
  title={\sffamily\bfseries Track: #1},
  check odd page=true,
  before upper={\setlength{\parskip}{0.75em}\renewcommand{\currboxcolor}{TrackOrange}\intcbtrue},
  after upper={\intcbfalse}
}
\newcommand{\tryitsection}{\textbf{\large \textcolor{IdeaBlue}{\sffamily Try This!}}}
\newcommand{\boxtitle}[1]{\def\currentboxtitle{#1}\textbf{\sffamily \large \textcolor{\currboxcolor}{#1}}}

\makeatletter
\newcommand{\onfloatpage}[2]{
    % #1 = float label
  % #2 = code to run
  \AddToHook{shipout/foreground}{%
    \begingroup
      \edef\ShipoutPage{\the\c@page}%
      \edef\TargetPage{\getpagerefnumber{#1}}%
      \ifx\ShipoutPage\TargetPage
        #2%
        \RemoveFromHook{shipout/foreground}%
      \fi
    \endgroup
  }%
}
\makeatother

\newcommand{\margmark}[2]{
  \tikzmarknode{#1}{\strut}
  \makemargmark{#1}{#2}
}

\makeatletter
\newcommand{\makemargmark@odd}[2]{
  \tikz[remember picture,overlay]{
    \coordinate (x) at ([xshift=\marginparsep]current page text area.east |- #1.east);
    \node[anchor=west, align=left, font=\footnotesize, text width=\marginparwidth] at (x) {\begin{minipage}{\marginparwidth}\sffamily #2\end{minipage}};
  }
}
\newcommand{\makemargmark@even}[2]{
  \tikz[remember picture,overlay]{
    \coordinate (x) at ([xshift=-\marginparsep]current page text area.west |- #1.east);
    \node[anchor=east, align=left, font=\footnotesize, text width=\marginparwidth] at (x) {\begin{minipage}{\marginparwidth}\sffamily #2\end{minipage}};
  }
}

\newcommand{\makemargmark}[2]{
  \ifintcb
  \tcbifoddpage{\makemargmark@odd{#1}{#2}}{\makemargmark@even{#1}{#2}}
  \else
  \checkoddpage
  \ifoddpage
  \makemargmark@odd{#1}{#2}
  \else
  \makemargmark@even{#1}{#2}
  \fi
  \fi
}

\newcommand{\bookboxmargin}[2]{% #1=id, #2=text
  \AddToShipoutPictureFG*{%
    \put(0,0){%
      \makebox[0pt][l]{%
        \raisebox{\zposy{#1}sp}{%
          % crude "outer margin" x placement; tune to tufte-book geometry
          \hspace*{\paperwidth-\marginparwidth-1in}%
          \parbox{\marginparwidth}{\footnotesize #2}%
        }%
      }%
    }%
  }%
}
\usepackage{titlesec}
\titleformat{\chapter}
  {\sffamily\bfseries\Huge}
  {\thechapter}{0.8em}{}
\titleformat{\section}
  {\sffamily\bfseries\Large}
  {\thesection}{0.8em}{}
\titleformat{\subsection}
  {\sffamily\bfseries\large}
  {\thesubsection}{0.8em}{}


% Optional: Track margin callout
  \definecolor{TrackOrange}{HTML}{FF7F0E} % if not already defined
  \newcommand{\fixfigure}{\checkoddpage \ifoddpage \forcerectofloat \else \forceversofloat \fi}
  \AtBeginEnvironment{figure}{\fixfigure}
  \AtBeginEnvironment{table}{\fixfigure}
\newcommand{\mTrackBox}[2]{\marginbox{Track: #1}{TrackOrange}{#2}}
\newcommand{\marginbox}[3]{\marginnote{\textsf{\textbf{\textcolor{#2}{#1}}}\\{\sffamily #3}}}

\definecolor{CodeBackground}{HTML}{F2F2F2}
\definecolor{CodeBorder}{HTML}{555555}
\newtcbox{\code}{
  on line,
  box align=base,
  colback=CodeBackground,
  colframe=CodeBorder,
  boxrule=0.6pt,
  arc=3pt,
  left=3pt,
  right=3pt,
  boxsep=1pt,
  top=0pt,
  bottom=0pt,
  fontupper=\ttfamily\footnotesize,
  nobeforeafter
}

% ---------- Lists ----------
\usepackage{enumitem}
\setlist[itemize]{topsep=0.2em,itemsep=0.2em,leftmargin=1.2em}
\setlist[enumerate]{topsep=0.2em,itemsep=0.2em,leftmargin=1.4em}

\newcounter{exerciseno}[chapter]
\renewcommand{\theexerciseno}{W\theweek-\arabic{exerciseno}}
\newcounter{week}

\makeatletter
\newwrite\weeks@dat
\openout\weeks@dat=\jobname.weeks.dat
\newcommand{\@tag}[1]{\string<#1\string>}
\newcommand{\resource}[2][]{
  \pgfkeys{/resource, default, #1}
  \def\resource@kind{\pgfkeysvalueof{/resource/kind}}
  \def\resource@url{#2}
  \def\resource@name{\pgfkeysvalueof{/resource/text}}
  \def\resource@sitename{\pgfkeysvalueof{/resource/site text}}
  \def\resource@includeqr{\pgfkeysvalueof{/resource/includeqr}}
  \def\resource@description{\pgfkeysvalueof{/resource/description}}
  \begingroup
    \protected@edef\resource@line{%
      RESOURCE \thepage\space
      \resource@kind\space
      \@tag{a href="\resource@url"}%
      \resource@sitename%
      \@tag{/a}%
      \space\detokenize{&mdash;}\space
      \resource@description%
    }%
    \immediate\write\weeks@dat{\resource@line}%
  \endgroup
  \href{\resource@name}{\resource@url}
  \ifnum\resource@includeqr=1
  \\
  \begin{center}
    \qrcode{#2}
  \end{center}
  \fi
}
\newcommand{\week}[2][]{%
  \pgfkeys{/week, description={}}
  \pgfkeys{/week, #1}
  \def\week@description{\pgfkeysvalueof{/week/description}}
  \refstepcounter{week}%
  \chapter{Week \theweek: #2}%
  \write\weeks@dat{NAME Week \theweek: #2}
  \write\weeks@dat{DESCRIPTION \week@description}m
}
\makeatother

\newlist{exercises}{enumerate}{1}
\setlist[exercises,1]{%
  label=\textcolor{IdeaBlue}{\sffamily\bfseries W\theweek-\arabic*},
  ref=W\theweek-\arabic*,
}

\settasks{
  label=\arabic*
}


\input{answers.tex}

% ---------- Keyboard ----------
\newcommand{\litkey}[1]{\;\tikz[baseline=-0.6ex]\node[draw,rounded corners=2pt,inner sep=2pt,font=\scriptsize\sffamily]{#1};}
\newcommand{\enterkey}{\litkey{Enter}}
\newcommand{\spacekey}{\litkey{Space}}
\newcommand{\tabkey}{\litkey{Tab}}
\newcommand{\controlkey}{\litkey{Control}}

% ---------- Code ----------
\usepackage{listings}

\definecolor{CodeKeyword}{HTML}{2F6FDB}  % calm blue
\definecolor{CodeComment}{HTML}{6A737D}  % soft gray
\definecolor{CodeString}{HTML}{2DA44E}   % muted green
\definecolor{CodeNumber}{HTML}{8A4F7D}   % gentle plum
\definecolor{CodeBuiltin}{HTML}{B45309}  % warm amber

\newcommand{\kw}[1]{\texttt{\textbf{\textcolor{CodeKeyword}{#1}}}}

\lstdefinestyle{kidcode}{
  backgroundcolor=\color{SoftGray},
  basicstyle=\ttfamily\small,
  frame=single,
  rulecolor=\color{black!25},
  breaklines=true,
  showstringspaces=false,
  tabsize=2,
  xleftmargin=0.5em,
  xrightmargin=0.5em,
  escapeinside={(*@}{@*)},
  literate=
    {<ENTER>}{\enterkey}7
    {<SPACE>}{\spacekey}5
}
\lstset{
  style=kidcode,
  language=Python,
  keywordstyle=\color{CodeKeyword}\bfseries,
  commentstyle=\color{CodeComment}\itshape,
  stringstyle=\color{CodeString},
  basicstyle=\ttfamily\small,
  showstringspaces=false,
  moredelim=**[is][\itshape]{@@}{@@}
}

% ---------- “Tufte-style” margin helpers ----------
% tufte-book already provides \marginnote and \marginfigure.
% These wrappers keep your usage consistent.

\def\notestyle{\raggedright\sffamily\footnotesize\color{black}}
\newcommand{\aside}[1]{\marginnote{\notestyle\color{black}#1}}
\newcommand{\curious}[1]{\marginnote{\notestyle\curiousboxtext\color{black}#1}}
\newcommand{\didyouknow}[1]{\marginnote{\notestyle\textbf{\textcolor{IdeaBlue}{Did You Know? }}\color{black}#1}}
\newcommand{\hint}[1]{\marginnote{\notestyle\hintnote\color{black}#1}}
\newcommand{\huh}[2]{\marginnote{\notestyle\huhnote{#1}\\\color{black}#2}}

\def\huhnote#1{\textbf{\textcolor{HuhRed}{\sffamily Confused?}}\\\textbf{#1}}
\def\hintnote{\textbf{\textcolor{TryGreen}{\sffamily Hint}} }
\def\curiousboxtext{\textbf{\textcolor{DeepPurple}{\sffamily Curious? }}}

% A margin image helper (use with an image file in images/)
\newcommand{\asideimg}[2][]{%
  \marginnote{\includegraphics[width=\marginparwidth,#1]{#2}}
}

\newcommand{\term}[1]{\textcolor{DefinitionAmber}{\textbf{#1}}}
\newcommand{\termheading}[1]{%
  \par\medskip
      {\sffamily\large\bfseries \textcolor{TermSage}{#1}}\par
      \vspace{0.4\baselineskip}
}

\makeatletter
\newcounter{subfigure}[figure]
\renewcommand\thesubfigure{\thefigure(\alph{subfigure})}
\newcommand{\subcaption}[1]{
  \vspace{0.5em}

  \refstepcounter{subfigure}
  \edef\@currentlabel{\thefigure(\alph{subfigure})}
  \sffamily \footnotesize
  \textbf{\textcolor{CaptionLabelSlate}{(\alph{subfigure})}} #1

  \vspace{0.5em}
}
\newenvironment{subfigure}[1]{
  \begin{minipage}{#1}
}{\end{minipage}}
\makeatother

% ---------- Document ----------
\title{Classical Computer Science}
\author{Travis Athougies}
\date{}


\begin{document}
\maketitle
\tableofcontents

\mainmatter
\input{../week1/chapter.tex}
\input{../week2/chapter.tex}
\input{../week3/chapter.tex}
\input{../week4/chapter.tex}
%\input{../week4/chapter.tex}

\appendix

\chapter{Answers}

\printanswers

\end{document}
