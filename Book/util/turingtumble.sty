% turingtumble.tikzlibrary.tex
% Stylized "Turing Tumble" board drawing helpers (diagramming, not simulation)
%
% Usage:
%   \input{turingtumble.tikzlibrary.tex}
%   \begin{tikzpicture}
%     \TTBoard[cols=8,rows=10,pegs=true]
%     \TTBit{3}{6}[state=0]
%     \TTMarble{1}{10}
%     \TTArrow{1}{10}{2}{9}
%   \end{tikzpicture}

\ProvidesPackage{turingtumble}[2026/01/11 Stylized Turing Tumble Tikz helpers]

\RequirePackage{tikz}
\usetikzlibrary{arrows.meta,calc,positioning}

% ----------------------------
% Key-value configuration
% ----------------------------
\pgfkeys{
  /tt/.is family, /tt,
  cols/.initial=8,
  rows/.initial=10,
  unit/.initial=8mm,        % grid spacing
  pegs/.initial=true,
  peg radius/.initial=1.2pt,
  board pad/.initial=0.7,   % padding in "grid units"
  board round/.initial=4pt,
  board thick/.initial=0.9pt,
  peg color/.initial=black,
  board color/.initial=black,
  label/.initial=,
}

% Piece keys
\pgfkeys{
  /tt/piece/.is family, /tt/piece,
  name/.initial=,
  fill/.initial=gray!10,
  draw/.initial=black,
  line/.initial=0.7pt,
}

\pgfkeys{
  /tt/bit/.is family, /tt/bit,
  state/.initial=0, % 0 or 1
}

\pgfkeys{
  /tt/marble/.is family, /tt/marble,
  fill/.initial=white,
  draw/.initial=black,
  r/.initial=1.7pt,
}

\pgfkeys{
  /tt/arrow/.is family, /tt/arrow,
  style/.initial={thick}, %-Latex},
  label/.initial=,
  label pos/.initial=0.5,
  label opts/.initial={font=\small,fill=white,inner sep=1pt},
}

% ----------------------------
% Coordinate system helpers
% ----------------------------
% We draw on a staggered peg grid like a Galton board:
% Even rows have pegs at integer x; odd rows shifted by +0.5.
%
% \TTCoord{x}{y} expands to a coordinate
\newcommand{\TTCoord}[2]{($ (#1,#2) + ({0.5*mod(#2,2)},0) $)}

% Named coordinate for later use: \TTMark{name}{x}{y}
\newcommand{\TTMark}[3]{%
  \coordinate (#1) at \TTCoord{#2}{#3};
}

% ----------------------------
% TikZ styles
% ----------------------------
\tikzset{
  tt/peg/.style={circle, fill=\pgfkeysvalueof{/tt/peg color}, inner sep=\pgfkeysvalueof{/tt/peg radius}},
  tt/board/.style={rounded corners=\pgfkeysvalueof{/tt/board round}, draw=\pgfkeysvalueof{/tt/board color}, line width=\pgfkeysvalueof{/tt/board thick}},
  tt/piecebox/.style={rounded corners=2pt, draw, line width=\pgfkeysvalueof{/tt/piece/line}, fill=\pgfkeysvalueof{/tt/piece/fill}},
  tt/marble/.style={circle, draw=\pgfkeysvalueof{/tt/marble/draw}, fill=\pgfkeysvalueof{/tt/marble/fill}, inner sep=\pgfkeysvalueof{/tt/marble/r}},
}

% ----------------------------
% Board macro
% ----------------------------
% \TTBoard[cols=...,rows=...,unit=...,pegs=true,label=...]
\newcommand{\TTBoard}[1][]{%
  \pgfkeys{/tt, #1}%
  \def\TTCols{\pgfkeysvalueof{/tt/cols}}%
  \def\TTRows{\pgfkeysvalueof{/tt/rows}}%
  \def\TTUnit{\pgfkeysvalueof{/tt/unit}}%
  \def\TTPad{\pgfkeysvalueof{/tt/board pad}}%
  \def\TTLabel{\pgfkeysvalueof{/tt/label}}%

  % Scale the entire picture by unit
  \begin{scope}[x=\TTUnit, y=\TTUnit]

    % Outer board rectangle
    \draw[tt/board]
      (-\TTPad,-\TTPad) rectangle (\TTCols+\TTPad,\TTRows+\TTPad);

    % Optional label/title
    \ifx\TTLabel\empty\else
      \node[font=\small] at (\TTCols/2,\TTRows+\TTPad+0.35) {\TTLabel};
    \fi

    % Peg grid
    \edef\TTPegs{\pgfkeysvalueof{/tt/pegs}}%
    \def\TTtrue{true}%
    \ifx\TTPegs\TTtrue
      \foreach \y in {0,...,\TTRows} {
        \foreach \x in {0,...,\TTCols} {
          % compute staggered x position
          \pgfmathsetmacro{\xs}{\x + (mod(\y,2)==0 ? 0 : 0.5)}
          % Only draw if inside board
          \ifdim \xs pt < -0.01pt \else
            \ifdim \xs pt > \TTCols pt \else
              \node[tt/peg] at (\xs,\y) {};
            \fi
          \fi
        }
      }
    \fi
  \end{scope}
}

% ----------------------------
% Marble and arrows
% ----------------------------
% \TTMarble{x}{y}[fill=...,draw=...,r=...]
\newcommand{\TTMarble}[3][]{%
  \pgfkeys{/tt/marble, #1}%
  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    \node[tt/marble] at \TTCoord{#2}{#3} {};
  \end{scope}
}

% \TTArrow{x1}{y1}{x2}{y2}[style=...,label=...]
\newcommand{\TTArrow}[5][]{%
  \pgfkeys{/tt/arrow, #1}%

  \pgfkeysgetvalue{/tt/arrow/style}{\TTArrowStyle}%
  \pgfkeysgetvalue{/tt/arrow/label}{\TTArrowLabel}%
  \pgfkeysgetvalue{/tt/arrow/label pos}{\TTArrowLabelPos}%
  \pgfkeysgetvalue{/tt/arrow/label opts}{\TTArrowLabelOpts}%

  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    % 1) Always draw the arrow line
    \draw[\expandafter\@firstofone\TTArrowStyle]
      \TTCoord{#2}{#3} -- \TTCoord{#4}{#5};

    % 2) Only add the label as a separate path (no TikZ parser weirdness)
    \edef\tt@lab{\TTArrowLabel}%
    \ifx\tt@lab\pgfutil@empty
      % no label
    \else
      \path
        \TTCoord{#2}{#3} -- \TTCoord{#4}{#5}
        node[pos=\TTArrowLabelPos] {\TTArrowLabel};
    \fi
  \end{scope}%
}

% ----------------------------
% Pieces (stylized)
% ----------------------------

% 1) Bit
% \TTBit{x}{y}[state=0|1,name=...]
\newcommand{\TTBit}[3][]{%
  \pgfkeys{/tt/piece, /tt/bit, #1}%
  \def\TTBitState{\pgfkeysvalueof{/tt/bit/state}}%
  \def\TTName{\pgfkeysvalueof{/tt/piece/name}}%
  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    \coordinate (tt@bit@pos) at  \TTCoord{#2}{#3}; %($ (#2,#3) + ({0.5*mod(#3,2)},0) $);%

    % box
    \node[tt/piecebox, minimum width=1.7, minimum height=0.75] (tt@bit@box) at (tt@bit@pos) {};

    % state indicator: small filled circle on left (0) or right (1)
    \pgfmathsetmacro{\dx}{(\TTBitState==0 ? -0.5 : 0.5)}
    \filldraw[draw=\pgfkeysvalueof{/tt/piece/draw}, fill=\pgfkeysvalueof{/tt/piece/draw}, line width=0.4pt]
      ($(tt@bit@box.center)+(\dx,0)$) circle (0.08);

    % label
    \node[font=\scriptsize] at (tt@bit@box.center) {Bit};

    % optionally name the coordinate
    \ifx\TTName\empty\else
      \coordinate (\TTName) at (tt@bit@pos);
    \fi
  \end{scope}
}

% 2) Ramp (deflector). direction = L or R
% \TTRampL{x}{y}[name=...]
% \TTRampR{x}{y}[name=...]
\newcommand{\TTRampL}[3][]{\TT@Ramp[dir=L,#1]{#2}{#3}}
\newcommand{\TTRampR}[3][]{\TT@Ramp[dir=R,#1]{#2}{#3}}

\pgfkeys{/tt/ramp/.is family, /tt/ramp,
  dir/.initial=L,
}

\newcommand{\TT@Ramp}[3][]{%
  \pgfkeys{/tt/piece, /tt/ramp, #1}%
  \def\TTDir{\pgfkeysvalueof{/tt/ramp/dir}}%
  \def\TTName{\pgfkeysvalueof{/tt/piece/name}}%
  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    \coordinate (tt@ramp@pos) at \TTCoord{#2}{#3};
    % Draw a little slanted bar inside an invisible box
    \node[tt/piecebox, minimum width=1.25, minimum height=0.55] (tt@ramp@box) at (tt@ramp@pos) {};
    \ifx\TTDir L
      \draw[line width=1.2pt] ($(tt@ramp@box.center)+(-0.35,0.18)$) -- ($(tt@ramp@box.center)+(0.35,-0.18)$);
      \node[font=\scriptsize] at ($(tt@ramp@box.center)+(0,0.25)$) {Ramp};
    \else
      \draw[line width=1.2pt] ($(tt@ramp@box.center)+(-0.35,-0.18)$) -- ($(tt@ramp@box.center)+(0.35,0.18)$);
      \node[font=\scriptsize] at ($(tt@ramp@box.center)+(0,0.25)$) {Ramp};
    \fi
    \ifx\TTName\empty\else
      \coordinate (\TTName) at (tt@ramp@pos);
    \fi
  \end{scope}
}

% 3) Crossover (two paths cross without interacting, schematic X)
% \TTCrossover{x}{y}[name=...]
\newcommand{\TTCrossover}[3][]{%
  \pgfkeys{/tt/piece, #1}%
  \def\TTName{\pgfkeysvalueof{/tt/piece/name}}%
  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    \coordinate (tt@x@pos) at \TTCoord{#2}{#3};
    \node[tt/piecebox, minimum width=1.25, minimum height=0.55] (tt@x@box) at (tt@x@pos) {};
    \draw[line width=1pt] ($(tt@x@box.center)+(-0.35,-0.18)$) -- ($(tt@x@box.center)+(0.35,0.18)$);
    \draw[line width=1pt] ($(tt@x@box.center)+(-0.35,0.18)$) -- ($(tt@x@box.center)+(0.35,-0.18)$);
    \node[font=\scriptsize] at ($(tt@x@box.center)+(0,0.27)$) {X};
    \ifx\TTName\empty\else
      \coordinate (\TTName) at (tt@x@pos);
    \fi
  \end{scope}
}

% 4) Interceptor-ish "Gate" (simple: blocks one side, passes other)
% This is NOT product-accurateâ€”it's a diagram symbol.
% \TTGate{x}{y}[open=L|R,name=...]
\pgfkeys{/tt/gate/.is family, /tt/gate,
  open/.initial=L,
}
\newcommand{\TTGate}[3][]{%
  \pgfkeys{/tt/piece, /tt/gate, #1}%
  \def\TTOpen{\pgfkeysvalueof{/tt/gate/open}}%
  \def\TTName{\pgfkeysvalueof{/tt/piece/name}}%
  \begin{scope}[x=\pgfkeysvalueof{/tt/unit}, y=\pgfkeysvalueof{/tt/unit}]
    \coordinate (tt@g@pos) at \TTCoord{#2}{#3};
    \node[tt/piecebox, minimum width=1.7, minimum height=0.75] (tt@g@box) at (tt@g@pos) {};
    % Draw a "door" that swings, schematic
    \draw[line width=1pt] ($(tt@g@box.center)+(0,-0.15)$) -- ($(tt@g@box.center)+(0,0.25)$);
    \ifx\TTOpen L
      \draw[line width=1pt] ($(tt@g@box.center)+(0,0.10)$) -- ($(tt@g@box.center)+(-0.45,-0.10)$);
      \node[font=\scriptsize] at ($(tt@g@box.center)+(0,0.30)$) {Gate L};
    \else
      \draw[line width=1pt] ($(tt@g@box.center)+(0,0.10)$) -- ($(tt@g@box.center)+(0.45,-0.10)$);
      \node[font=\scriptsize] at ($(tt@g@box.center)+(0,0.30)$) {Gate R};
    \fi
    \ifx\TTName\empty\else
      \coordinate (\TTName) at (tt@g@pos);
    \fi
  \end{scope}
}

% ----------------------------
% Convenience: show "rule arrows" around a piece
% ----------------------------
% \TTBitRuleArrows{x}{y}[state=0|1]
% Draws incoming arrow to bit and outgoing left/right arrows labeled 0/1.
\newcommand{\TTBitRuleArrows}[3][]{%
  \pgfkeys{/tt/bit, #1}%
  \def\TTBitState{\pgfkeysvalueof{/tt/bit/state}}%
  % incoming (above -> center)
  \TTArrow[style={-Latex, thick}]{#2}{#3+2}{#2}{#3+1}[label=]
  % outgoing possibilities (below to left/right)
  \TTArrow[style={-Latex, thick},label={0}]{#2}{#3}{#2-1}{#3-1}
  \TTArrow[style={-Latex, thick, dashed},label={1}]{#2}{#3}{#2+1}{#3-1}
}
